<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Surveillance Panneau Solaire</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <header>
        <%- include('partials/header1') %>
        <%- include('partials/header2') %>
    </header>
    <main>
        <%- body %>
    </main>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script>
        async function redirectTo(url){
            /* const idToken = await getIdToken();
            fetch(url, {
                headers: {
                    'Authorization': 'Bearer ' + idToken
                }
            }).then(res => res.text())
            .then(data =>  document.body.innerHTML = data); */
            window.location.href = url
        }    

        const firebaseConfig = {
            apiKey: "AIzaSyA36nylSZt5jnO7qQLeoev9DqDRBTTdcVY",
            authDomain: "aer-monitoring-90aac.firebaseapp.com",
            projectId: "aer-monitoring-90aac",
            storageBucket: "aer-monitoring-90aac.firebasestorage.app",
            messagingSenderId: "635346538722",
            appId: "1:635346538722:web:d984aa2573f41e7ff2cebb",
            measurementId: "G-RLJM4TZ0NP"
        };
        firebase.initializeApp(firebaseConfig);

        function login(email, password) {
            firebase.auth().signInWithEmailAndPassword(email, password)
            .then((userCredential) => {
                return userCredential.user.getIdToken();
            })
            .then((idToken) => {
                // Send idToken to your Express backend in Authorization header
                //redirectTo('/');
                /* console.log(`user connected`)
                fetch('/', {
                headers: {
                    'Authorization': 'Bearer ' + idToken
                }
                }) */
                /*.then(res => res.text())
                .then(data => alert(data)); */
                return true;
            })
            .catch((error) => {
                //alert (`Identifiants de connexion incorrect`)
                alert(error.message);
                return false;
            });
        }
        
        function signup(email, password) {
            firebase.auth().createUserWithEmailAndPassword(email, password)
            .then((userCredential) => {
                return userCredential.user.getIdToken();
            })
            .then((idToken) => {
                // Send idToken to your Express backend in Authorization header
                // redirectTo('/');
                /* fetch('/', {
                headers: {
                    'Authorization': 'Bearer ' + idToken
                }
                })
                .then(res => res.text())
                .then(data => alert(data)); */
                return true;
            })
            .catch((error) => {
                alert (`Identifiants de connexion incorrect`)
                // alert(error.message);
                return false
            });
        }
        
        function checkUserConnected (){
            //return firebase.auth().onAuthStateChanged( (user) => { return user; });  
            return firebase.auth().currentUser;              
        }

        function getIdToken (){
            const user = checkUserConnected();
            return user ? user.getIdToken() : null;
        }

        const loginForm = document.getElementById("login-form");

        loginForm.addEventListener("submit", function(event) {
            event.preventDefault(); // empêche le rechargement
            const username = document.getElementById("input_username").value;
            const password = document.getElementById("input_password").value;

            console.log(`username : ${username}`)
            login(username, password)
            
            if ( checkUserConnected() ){
                // redirectTo("/")
                /* const idToken = await getIdToken();
                console.log(`idToken : ${idToken}`) */
                redirectTo ("/")            
            }
            //alert ("Information de connexion invalides")
        });

        const registerForm = document.getElementById("register-form");

        registerForm.addEventListener("submit", function(event) {
            event.preventDefault(); // empêche le rechargement
            const username = document.getElementById("input_username").value;
            const password = document.getElementById("input_password").value;

            console.log(`username : ${username}`)
            if ( signup(username, password) ){
                redirectTo("/")
            }
            alert ("Information de connexion invalides")
        });
    </script>
    <script>
        firebase.auth().onAuthStateChanged((user) => {
            const userInfoContainer = document.getElementById("user-info");
            const authLinksContainer = document.getElementById("auth-links");
            authLinksContainer.innerHTML = "";
        
            if (user) {
                // Exemple avec user.photoURL
                const userImage = document.createElement("img");
                userImage.src = user.photoURL 
                //|| 'default-avatar.png'; // Fallback si pas de photo
                userImage.alt = user.email[0];
                userImage.className = "user-img";
        
                userInfoContainer.appendChild(userImage);

                // Lien Déconnexion
                const logoutLink = document.createElement("a");
                logoutLink.className = "link link-green";
                logoutLink.href = "#";
                logoutLink.textContent = "Déconnexion";
                logoutLink.onclick = function (e) {
                    e.preventDefault();
                    firebase.auth().signOut().then(() => {
                        window.location.href = "/"; // ou '/', selon ton besoin
                    });
                };
                authLinksContainer.appendChild(logoutLink);
            } else {
                // Optionnel : ajouter autre chose si pas connecté (ex: bouton de login)
                userInfoContainer.innerHTML = ''; // Ou un lien de connexion

                // Lien Connexion
                const loginLink = document.createElement("a");
                loginLink.className = "link link-green";
                loginLink.href = "/login";
                loginLink.textContent = "Connexion";
                authLinksContainer.appendChild(loginLink);
            }
        });
    </script>
</body>
</html>